<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´ë©”ë¼ ìº¡ì²˜ ê°¤ëŸ¬ë¦¬ - GZONESOFT</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
    <style>
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3rem 0;
            text-align: center;
        }
        .capture-gallery {
            padding: 2rem 0;
        }
        .capture-item {
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            margin-bottom: 2rem;
        }
        .capture-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }
        .capture-preview {
            position: relative;
            overflow: hidden;
            border-radius: 0.375rem;
        }
        .capture-preview img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        .capture-preview:hover img {
            transform: scale(1.05);
        }
        .capture-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            align-items: end;
            padding: 1rem;
        }
        .capture-preview:hover .capture-overlay {
            opacity: 1;
        }
        .capture-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .empty-gallery {
            text-align: center;
            padding: 4rem 0;
            color: #6c757d;
        }
        .stream-controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .live-indicator {
            display: inline-flex;
            align-items: center;
            background: #dc3545;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        .live-indicator .pulse-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            margin-right: 0.5rem;
            animation: pulse-dot 2s infinite;
        }
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <!-- Hero Section -->
    <div class="hero-section">
        <div class="container">
            <h1 class="display-4 mb-4">
                <i class="fas fa-camera me-3"></i>
                ì¹´ë©”ë¼ ìº¡ì²˜ ê°¤ëŸ¬ë¦¬
            </h1>
            <p class="lead mb-4">ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ì—ì„œ ìº¡ì²˜í•œ ì‚¬ì§„ë“¤ì„ ê´€ë¦¬í•˜ì„¸ìš”</p>
            <div class="d-flex justify-content-center gap-3">
                <button class="btn btn-warning btn-lg" onclick="togglePositionDataSection()">
                    <i class="fas fa-database me-2"></i>
                    ë¡œì»¬/ì„œë²„ ì¡°íšŒ
                    <span class="badge bg-danger ms-2" id="localPositionBadge">0</span>
                </button>
                <button class="btn btn-info btn-lg" onclick="window.open('/position-monitor.html', '_blank')">
                    <i class="fas fa-chart-line me-2"></i>
                    ëª¨ë‹ˆí„°ë§
                </button>
            </div>
        </div>
    </div>

    <div class="container capture-gallery">
        <!-- ìœ„ì¹˜ ë°ì´í„° ê´€ë¦¬ ì„¹ì…˜ -->
        <div class="position-data-section mb-4" style="display: none;" id="positionDataSection">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
                    <ul class="nav nav-tabs card-header-tabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" id="local-tab" data-bs-toggle="tab" data-bs-target="#local-data" type="button" role="tab" style="color: #333;">
                                <i class="fas fa-database me-2"></i>ë¡œì»¬ ìŠ¤í† ë¦¬ì§€
                                <span class="badge bg-warning ms-2" id="localTabBadge">0</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="server-tab" data-bs-toggle="tab" data-bs-target="#server-data" type="button" role="tab" style="color: #fff;">
                                <i class="fas fa-cloud me-2"></i>ì„œë²„ ì¡°íšŒ
                                <span class="badge bg-info ms-2" id="serverTabBadge">0</span>
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <!-- íƒ­ ì»¨í…ì¸  -->
                    <div class="tab-content">
                        <!-- ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ íƒ­ -->
                        <div class="tab-pane fade show active" id="local-data" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="selectAllPositions()">
                                <i class="fas fa-check-square me-1"></i>ì „ì²´ ì„ íƒ
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="deselectAllPositions()">
                                <i class="fas fa-square me-1"></i>ì„ íƒ í•´ì œ
                            </button>
                            <button class="btn btn-sm btn-success" onclick="sendSelectedPositions()">
                                <i class="fas fa-upload me-1"></i>ì„ íƒ í•­ëª© ì „ì†¡
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSelectedPositions()">
                                <i class="fas fa-trash me-1"></i>ì„ íƒ í•­ëª© ì‚­ì œ
                            </button>
                        </div>
                        <button class="btn btn-sm btn-info" onclick="refreshPositionData()">
                            <i class="fas fa-sync me-1"></i>ìƒˆë¡œê³ ì¹¨
                        </button>
                    </div>
                    <div class="position-list" id="positionList" style="max-height: 300px; overflow-y: auto;">
                        <!-- ìœ„ì¹˜ ë°ì´í„° ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                        </div>
                        
                        <!-- ì„œë²„ ì¡°íšŒ íƒ­ -->
                        <div class="tab-pane fade" id="server-data" role="tabpanel">
                            <div class="server-query-controls mb-3">
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <label class="form-label small">ë””ë°”ì´ìŠ¤ ID</label>
                                        <input type="text" class="form-control form-control-sm" id="serverDeviceId" value="DJI_DEVICE_001" placeholder="ë””ë°”ì´ìŠ¤ ID">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">ì‹œì‘ ë‚ ì§œ</label>
                                        <input type="datetime-local" class="form-control form-control-sm" id="serverStartDate">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">ì¢…ë£Œ ë‚ ì§œ</label>
                                        <input type="datetime-local" class="form-control form-control-sm" id="serverEndDate">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">ì¡°íšŒ ê±´ìˆ˜</label>
                                        <input type="number" class="form-control form-control-sm" id="serverLimit" value="100" min="1" max="1000">
                                    </div>
                                </div>
                                <div class="mt-3 d-flex gap-2 flex-wrap">
                                    <button class="btn btn-primary" onclick="queryServerPositions()">
                                        <i class="fas fa-search me-1"></i>ì¡°íšŒ
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="setTimeRange(1)">
                                        <i class="fas fa-clock me-1"></i>ìµœê·¼ 1ì‹œê°„
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="setTimeRange(6)">
                                        <i class="fas fa-clock me-1"></i>ìµœê·¼ 6ì‹œê°„
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="setTimeRange(24)">
                                        <i class="fas fa-calendar-day me-1"></i>1ì¼ ë™ì•ˆ
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="setTimeRange(168)">
                                        <i class="fas fa-calendar-week me-1"></i>1ì£¼ì¼ ë™ì•ˆ
                                    </button>
                                </div>
                            </div>
                            <div class="server-position-list" id="serverPositionList" style="max-height: 400px; overflow-y: auto;">
                                <!-- ì„œë²„ ì¡°íšŒ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìŠ¤íŠ¸ë¦¼ ì œì–´ íŒ¨ë„ -->
        <div class="stream-controls">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-3 mb-md-0">
                        <div class="live-indicator me-3">
                            <div class="pulse-dot"></div>
                            LIVE
                        </div>
                        <div>
                            <h5 class="mb-0" id="currentStreamTitle">ìŠ¤íŠ¸ë¦¼: <span id="streamKeyDisplay">-</span></h5>
                            <small class="text-muted">ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ì¤‘</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex gap-2 justify-content-md-end">
                        <button class="btn btn-primary" onclick="goBackToWatch()">
                            <i class="fas fa-video me-2"></i>ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                        </button>
                        <button class="btn btn-success" onclick="captureFromStream()" id="captureFromStreamBtn" disabled>
                            <i class="fas fa-camera me-2"></i>ìº¡ì²˜í•˜ê¸°
                        </button>
                        <button class="btn btn-outline-danger" onclick="clearAllCaptures()">
                            <i class="fas fa-trash me-2"></i>ì „ì²´ ì‚­ì œ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìº¡ì²˜ ê°¤ëŸ¬ë¦¬ -->
        <div class="row" id="captureGallery">
            <!-- ìº¡ì²˜ëœ ì´ë¯¸ì§€ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>

        <!-- ë¹ˆ ê°¤ëŸ¬ë¦¬ ë©”ì‹œì§€ -->
        <div id="emptyGallery" class="empty-gallery">
            <i class="fas fa-camera fa-4x mb-3"></i>
            <h4>ì•„ì§ ìº¡ì²˜ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤</h4>
            <p>ìŠ¤íŠ¸ë¦¼ì—ì„œ ë§ˆìŒì— ë“œëŠ” ìˆœê°„ì„ ìº¡ì²˜í•´ë³´ì„¸ìš”!</p>
            <button class="btn btn-primary" onclick="goBackToWatch()">
                <i class="fas fa-video me-2"></i>ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ì´ë™
            </button>
        </div>
    </div>

    <!-- ì´ë¯¸ì§€ ìƒì„¸ ë³´ê¸° ëª¨ë‹¬ -->
    <div class="modal fade" id="imageDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-image me-2"></i>
                        ìº¡ì²˜ ì´ë¯¸ì§€ ìƒì„¸
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" alt="ìº¡ì²˜ ì´ë¯¸ì§€" class="img-fluid">
                    <div class="mt-3" id="imageInfo">
                        <!-- ì´ë¯¸ì§€ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="sendPositionDataToServer()">
                        <i class="fas fa-cloud-upload-alt me-2"></i>ì„œë²„ ì „ì†¡
                    </button>
                    <button type="button" class="btn btn-success" onclick="downloadCurrentImage()">
                        <i class="fas fa-download me-2"></i>ë‹¤ìš´ë¡œë“œ
                    </button>
                    <button type="button" class="btn btn-danger" onclick="deleteCurrentImage()">
                        <i class="fas fa-trash me-2"></i>ì‚­ì œ
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ì„ì‹œ ì‘ì—… ë²„íŠ¼ ì„¹ì…˜ -->
    <div class="container mt-5">
        <div class="alert alert-warning">
            <h5><i class="fas fa-tools me-2"></i>ì„ì‹œ ì‘ì—… ë„êµ¬</h5>
            <button class="btn btn-danger btn-lg mt-2" onclick="syncFromServerFiles()">
                <i class="fas fa-sync-alt me-2"></i>
                ì„œë²„ íŒŒì¼(9/13)ë¡œ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì¬ìƒì„±
            </button>
            <p class="small mt-2 mb-0">âš ï¸ ì£¼ì˜: í˜„ì¬ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì˜ ëª¨ë“  ìº¡ì²˜ ë°ì´í„°ê°€ ì„œë²„ íŒŒì¼ë¡œ êµì²´ë©ë‹ˆë‹¤.</p>
        </div>
    </div>

    <!-- í‘¸í„° -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container text-center">
            <p class="mb-0">
                <i class="fas fa-camera me-2"></i>
                GZONESOFT ì¹´ë©”ë¼ ê°¤ëŸ¬ë¦¬ |
                <a href="https://ai.gzonesoft.com:17937" class="text-light">ê´€ë¦¬ì í˜ì´ì§€</a>
            </p>
            <small class="text-muted">ì‹¤ì‹œê°„ ìº¡ì²˜ Â· ê³ í™”ì§ˆ Â· ê°„í¸ ê´€ë¦¬</small>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="/js/capture-api-client.js"></script>
    <script src="/js/capture-api-config.js"></script>
    <script src="/js/position-api-client.js"></script>
    <script src="/js/position-api-config.js"></script>
    <script>
        class CameraGallery {
            constructor() {
                this.captures = [];
                this.currentStreamKey = null;
                this.currentImageId = null;
                this.init();
            }
            
            // ì•ˆì „í•œ ë‚ ì§œ í¬ë§·íŒ… í•¨ìˆ˜
            formatDate(timestamp) {
                try {
                    let date = timestamp;
                    if (typeof timestamp === 'string' || typeof timestamp === 'number') {
                        date = new Date(timestamp);
                    }
                    
                    if (date instanceof Date && !isNaN(date)) {
                        return date.toLocaleString();
                    }
                } catch (error) {
                    console.error('ë‚ ì§œ í¬ë§·íŒ… ì˜¤ë¥˜:', error);
                }
                return 'ì•Œ ìˆ˜ ì—†ìŒ';
            }

            getCaptureTypeTag(capture) {
                // captureType í™•ì¸ ë˜ëŠ” overlayData ì¡´ì¬ ì—¬ë¶€ë¡œ íŒë‹¨
                let type = '';
                let colorClass = '';
                
                if (capture.captureType === 'video_only') {
                    type = 'ì˜ìƒ';
                    colorClass = 'bg-danger';
                } else if (capture.captureType === 'with_overlay') {
                    type = 'ì˜¤ë²„';
                    colorClass = 'bg-primary';
                } else {
                    // captureTypeì´ ì—†ëŠ” ê²½ìš° overlayDataë¡œ íŒë‹¨
                    if (capture.overlayData && Object.keys(capture.overlayData).length > 0) {
                        type = 'ì˜¤ë²„';
                        colorClass = 'bg-primary';
                    } else {
                        type = 'ì˜ìƒ';
                        colorClass = 'bg-danger';
                    }
                }
                
                return `<span class="badge ${colorClass} ms-2" style="font-size: 0.7rem;">${type}</span>`;
            }

            async init() {
                // URLì—ì„œ ìŠ¤íŠ¸ë¦¼ í‚¤ ê°€ì ¸ì˜¤ê¸°
                const urlParams = new URLSearchParams(window.location.search);
                this.currentStreamKey = urlParams.get('key');
                
                if (this.currentStreamKey) {
                    document.getElementById('streamKeyDisplay').textContent = this.currentStreamKey;
                    document.getElementById('captureFromStreamBtn').disabled = false;
                }

                await this.loadCaptures();
                this.renderGallery();
                this.loadStreamStatus();

                // ìƒˆë¡œê³ ì¹¨ ì£¼ê¸° (ìƒˆ ìº¡ì²˜ í™•ì¸ìš©)
                setInterval(async () => {
                    await this.loadCaptures();
                    this.renderGallery();
                }, 10000); // 10ì´ˆë§ˆë‹¤ ìƒˆë¡œê³ ì¹¨
            }

            async loadStreamStatus() {
                try {
                    const response = await fetch('/api/streams');
                    const streams = await response.json();
                    
                    const activeStream = streams.find(s => s.streamKey === this.currentStreamKey);
                    if (activeStream) {
                        document.querySelector('.live-indicator').style.display = 'inline-flex';
                    } else {
                        document.querySelector('.live-indicator').style.display = 'none';
                    }
                } catch (error) {
                    console.error('ìŠ¤íŠ¸ë¦¼ ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨:', error);
                }
            }

            async loadCaptures() {
                try {
                    // APIë¥¼ í†µí•´ ìº¡ì²˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                    this.captures = await window.captureStorage.getCaptures(this.currentStreamKey);
                    console.log(`${this.captures.length}ê°œ ìº¡ì²˜ ë¡œë“œë¨`);
                } catch (error) {
                    console.error('ìº¡ì²˜ ë¡œë“œ ì‹¤íŒ¨:', error);
                    this.captures = [];
                }
            }

            async renderGallery() {
                try {
                    await this.loadCaptures(); // ë Œë”ë§ ì „ì— ìµœì‹  ë°ì´í„° ë¡œë“œ
                } catch (error) {
                    console.error('ìº¡ì²˜ ë¡œë“œ ì‹¤íŒ¨:', error);
                }
                
                const gallery = document.getElementById('captureGallery');
                const emptyMessage = document.getElementById('emptyGallery');

                if (!this.captures || this.captures.length === 0) {
                    gallery.innerHTML = '';
                    emptyMessage.style.display = 'block';
                    return;
                }

                emptyMessage.style.display = 'none';
                
                gallery.innerHTML = this.captures.map((capture, index) => `
                    <div class="col-md-4 col-lg-3">
                        <div class="card capture-item">
                            <div class="capture-preview" onclick="showImageDetail('${capture.id}')">
                                <img src="${capture.dataUrl || capture.imageUrl || capture.imageData || ''}" alt="ìº¡ì²˜ ${index + 1}">
                                <div class="capture-overlay">
                                    <div class="text-white">
                                        <small><i class="fas fa-clock me-1"></i>${new Date(capture.timestamp).toLocaleString()}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <h6 class="card-title mb-2">
                                    <i class="fas fa-camera me-1"></i>
                                    ìº¡ì²˜ #${index + 1}
                                    ${this.getCaptureTypeTag(capture)}
                                </h6>
                                <p class="card-text">
                                    <small class="text-muted">
                                        <i class="fas fa-key me-1"></i>ìŠ¤íŠ¸ë¦¼: ${capture.streamKey || 'ì•Œ ìˆ˜ ì—†ìŒ'}<br>
                                        <i class="fas fa-clock me-1"></i>${this.formatDate(capture.timestamp)}
                                    </small>
                                </p>
                                <div class="capture-actions">
                                    <button class="btn btn-sm btn-outline-primary" onclick="downloadCapture('${capture.id}')">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="showImageDetail('${capture.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCapture('${capture.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            async captureFromStream() {
                if (!this.currentStreamKey) {
                    this.showAlert('ìŠ¤íŠ¸ë¦¼ í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'warning');
                    return;
                }

                // ìº¡ì²˜ë¥¼ ìœ„í•´ watch.html í˜ì´ì§€ë¥¼ ìƒˆ íƒ­ì—ì„œ ì—´ê³  ìë™ ìº¡ì²˜ ì‹¤í–‰
                const watchUrl = `watch.html?key=${this.currentStreamKey}&autoCapture=true`;
                const watchWindow = window.open(watchUrl, 'streamCapture', 'width=1200,height=800');
                
                if (watchWindow) {
                    this.showAlert('ìŠ¤íŠ¸ë¦¼ í˜ì´ì§€ê°€ ì—´ë ¸ìŠµë‹ˆë‹¤. ìë™ìœ¼ë¡œ ìº¡ì²˜ë©ë‹ˆë‹¤.', 'info');
                    
                    // 5ì´ˆ í›„ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ìƒˆ ìº¡ì²˜ë¥¼ í™•ì¸
                    setTimeout(() => {
                        this.loadCaptures();
                        this.renderGallery();
                    }, 5000);
                } else {
                    this.showAlert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.', 'warning');
                }
            }

            addCapture(captureData) {
                this.captures.unshift(captureData);
                this.saveCaptures();
                this.renderGallery();
                this.showAlert('í™”ë©´ì´ ì„±ê³µì ìœ¼ë¡œ ìº¡ì²˜ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            }

            deleteCapture(captureId) {
                if (confirm('ì´ ìº¡ì²˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    this.captures = this.captures.filter(c => c.id !== captureId);
                    this.saveCaptures();
                    this.renderGallery();
                    this.showAlert('ìº¡ì²˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                }
            }

            clearAllCaptures() {
                if (confirm('ëª¨ë“  ìº¡ì²˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                    this.captures = [];
                    this.saveCaptures();
                    this.renderGallery();
                    this.showAlert('ëª¨ë“  ìº¡ì²˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                }
            }

            downloadCapture(captureId) {
                const capture = this.captures.find(c => c.id === captureId);
                if (!capture) return;

                // ì„œë²„ì— ì €ì¥ëœ ìº¡ì²˜ê°€ ìˆë‹¤ë©´ ì„œë²„ API ì‚¬ìš©
                if (capture.serverFilename) {
                    // ì„œë²„ APIë¥¼ í†µí•´ ìœ„ì¹˜ì •ë³´ ê¸°ë°˜ íŒŒì¼ëª…ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ
                    const downloadUrl = `/api/capture/download/${capture.serverFilename}`;
                    
                    // ìƒˆ íƒ­ì—ì„œ ë‹¤ìš´ë¡œë“œ (ë¸Œë¼ìš°ì € ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬)
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.target = '_blank';
                    link.download = ''; // ì„œë²„ì—ì„œ íŒŒì¼ëª… ê²°ì •
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showAlert('ìœ„ì¹˜ì •ë³´ ê¸°ë°˜ íŒŒì¼ëª…ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.', 'success');
                } else {
                    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì˜ ìº¡ì²˜ - ìœ„ì¹˜ ì •ë³´ ê¸°ë°˜ íŒŒì¼ëª… ìƒì„±
                    let downloadFilename = '';
                    
                    // ìœ„ì¹˜ ë°ì´í„° ì¶”ì¶œ (showImageDetailê³¼ ë™ì¼í•œ ë¡œì§)
                    let positionData = null;
                    
                    // 1. positionData ì§ì ‘ í™•ì¸
                    if (capture.positionData && capture.positionData.LATITUDE) {
                        positionData = capture.positionData;
                    }
                    // 2. overlayData ì§ì ‘ í™•ì¸
                    else if (capture.overlayData && capture.overlayData.LATITUDE) {
                        positionData = capture.overlayData;
                    }
                    // 3. overlayData.sensorData í™•ì¸
                    else if (capture.overlayData?.sensorData?.LATITUDE) {
                        positionData = capture.overlayData.sensorData;
                    }
                    // 4. overlayData.userScreenData.sensorData í™•ì¸
                    else if (capture.overlayData?.userScreenData?.sensorData?.LATITUDE) {
                        positionData = capture.overlayData.userScreenData.sensorData;
                    }
                    
                    // íƒ€ì„ìŠ¤íƒ¬í”„ ì²˜ë¦¬
                    let timestamp = capture.timestamp;
                    if (typeof timestamp === 'string' || typeof timestamp === 'number') {
                        timestamp = new Date(timestamp);
                    }
                    
                    // KST ì‹œê°„ìœ¼ë¡œ ë³€í™˜
                    const kstDate = new Date(timestamp.getTime() + (9 * 60 * 60 * 1000));
                    const dateStr = kstDate.toISOString().slice(0, 19).replace('T', '_').replace(/:/g, '');
                    
                    // ìœ„ì¹˜ ì •ë³´ê°€ ìˆìœ¼ë©´ ìœ„ì¹˜ ê¸°ë°˜ íŒŒì¼ëª… ìƒì„±
                    if (positionData && positionData.LATITUDE && positionData.LONGITUDE) {
                        const latitude = parseFloat(positionData.LATITUDE).toFixed(6);
                        const longitude = parseFloat(positionData.LONGITUDE).toFixed(6);
                        const altitude = Math.round(parseFloat(positionData.ALTITUDE || 0));
                        
                        // ì„œë²„ì™€ ë™ì¼í•œ íŒŒì¼ëª… í˜•ì‹: ë‚ ì§œ_ìœ„ë„_ê²½ë„_ê³ ë„
                        downloadFilename = `${dateStr}_${latitude}_${longitude}_${altitude}m.png`;
                    } else {
                        // ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ íŒŒì¼ëª…
                        downloadFilename = `stream-capture-${capture.streamKey || 'unknown'}-${dateStr}.png`;
                    }
                    
                    const link = document.createElement('a');
                    link.download = downloadFilename;
                    link.href = capture.dataUrl || capture.imageData;
                    link.click();
                    
                    console.log(`ğŸ“¥ ë‹¤ìš´ë¡œë“œ íŒŒì¼ëª…: ${downloadFilename}`);
                }
            }

            showImageDetail(captureId) {
                const capture = this.captures.find(c => c.id === captureId);
                if (!capture) return;

                this.currentImageId = captureId;
                
                document.getElementById('modalImage').src = capture.dataUrl || capture.imageUrl || capture.imageData || '';
                
                // ìœ„ì¹˜ ë°ì´í„° í™•ì¸ - ì—¬ëŸ¬ ê²½ë¡œ ì‹œë„
                let positionData = null;
                
                // 1. positionData ì§ì ‘ í™•ì¸
                if (capture.positionData && capture.positionData.LATITUDE) {
                    positionData = capture.positionData;
                }
                // 2. overlayData ì§ì ‘ í™•ì¸
                else if (capture.overlayData && capture.overlayData.LATITUDE) {
                    positionData = capture.overlayData;
                }
                // 3. overlayData.sensorData í™•ì¸
                else if (capture.overlayData?.sensorData?.LATITUDE) {
                    positionData = capture.overlayData.sensorData;
                }
                // 4. overlayData.userScreenData.sensorData í™•ì¸ (ì„œë²„ APIì™€ ë™ì¼í•œ ê²½ë¡œ)
                else if (capture.overlayData?.userScreenData?.sensorData?.LATITUDE) {
                    positionData = capture.overlayData.userScreenData.sensorData;
                }
                
                let positionInfoHtml = '';
                
                if (positionData && positionData.LATITUDE && positionData.LONGITUDE) {
                    // ìˆ«ìë¡œ ë³€í™˜í•˜ì—¬ toFixed ì‚¬ìš©
                    const lat = parseFloat(positionData.LATITUDE);
                    const lng = parseFloat(positionData.LONGITUDE);
                    const alt = parseFloat(positionData.ALTITUDE) || 0;
                    
                    positionInfoHtml = `
                        <div class="col-md-12 mb-3">
                            <h6><i class="fas fa-map-marker-alt me-2"></i>ìœ„ì¹˜ ì •ë³´</h6>
                            <ul class="list-unstyled">
                                <li><strong>ìœ„ë„:</strong> ${lat.toFixed(6)}Â°</li>
                                <li><strong>ê²½ë„:</strong> ${lng.toFixed(6)}Â°</li>
                                <li><strong>ê³ ë„:</strong> ${alt.toFixed(1)}m</li>
                                ${positionData.SPEED ? `<li><strong>ì†ë„:</strong> ${parseFloat(positionData.SPEED).toFixed(1)}km/h</li>` : ''}
                                ${positionData.BATTERY_LEVEL ? `<li><strong>ë°°í„°ë¦¬:</strong> ${Math.round(parseFloat(positionData.BATTERY_LEVEL))}%</li>` : ''}
                            </ul>
                        </div>
                    `;
                }
                
                document.getElementById('imageInfo').innerHTML = `
                    <div class="row text-start">
                        ${positionInfoHtml}
                        <div class="col-md-6">
                            <h6><i class="fas fa-info-circle me-2"></i>ìº¡ì²˜ ì •ë³´</h6>
                            <ul class="list-unstyled">
                                <li><strong>ìŠ¤íŠ¸ë¦¼ í‚¤:</strong> ${capture.streamKey || 'ì•Œ ìˆ˜ ì—†ìŒ'}</li>
                                <li><strong>ìº¡ì²˜ ì‹œê°„:</strong> ${this.formatDate(capture.timestamp)}</li>
                                <li><strong>í•´ìƒë„:</strong> ${capture.width || 'ì•Œ ìˆ˜ ì—†ìŒ'} Ã— ${capture.height || 'ì•Œ ìˆ˜ ì—†ìŒ'}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-chart-bar me-2"></i>íŒŒì¼ ì •ë³´</h6>
                            <ul class="list-unstyled">
                                <li><strong>íŒŒì¼ í¬ê¸°:</strong> ${this.formatFileSize((capture.dataUrl || capture.imageData || '').length * 0.75)}</li>
                                <li><strong>í˜•ì‹:</strong> PNG</li>
                                <li><strong>ID:</strong> ${(capture.id || '').substring(0, 8)}...</li>
                            </ul>
                        </div>
                    </div>
                `;

                const modal = new bootstrap.Modal(document.getElementById('imageDetailModal'));
                modal.show();
            }

            downloadCurrentImage() {
                if (this.currentImageId) {
                    this.downloadCapture(this.currentImageId);
                }
            }

            deleteCurrentImage() {
                if (this.currentImageId) {
                    this.deleteCapture(this.currentImageId);
                    bootstrap.Modal.getInstance(document.getElementById('imageDetailModal')).hide();
                }
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            goBackToWatch() {
                const streamKey = this.currentStreamKey;
                if (streamKey) {
                    window.location.href = `watch.html?key=${streamKey}`;
                } else {
                    window.location.href = 'watch.html';
                }
            }

            async saveCaptures() {
                // APIë¥¼ í†µí•´ ì €ì¥ (ë°°ì¹˜ ì €ì¥ ì‚¬ìš©)
                try {
                    if (this.captures.length > 0) {
                        await window.captureStorage.batchSaveCaptures(this.captures);
                    }
                } catch (error) {
                    console.error('ìº¡ì²˜ ì €ì¥ ì‹¤íŒ¨:', error);
                }
            }

            showAlert(message, type) {
                // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
                const existingAlert = document.querySelector('.floating-alert');
                if (existingAlert) {
                    existingAlert.remove();
                }
                
                // ìƒˆ ì•Œë¦¼ ìƒì„±
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} floating-alert`;
                alertDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 9999;
                    max-width: 400px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                `;
                
                alertDiv.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
                `;
                
                document.body.appendChild(alertDiv);
                
                // 3ì´ˆ í›„ ìë™ ì œê±°
                setTimeout(() => {
                    if (alertDiv.parentElement) {
                        alertDiv.remove();
                    }
                }, 3000);
            }
        }

        // ì „ì—­ ì¸ìŠ¤í„´ìŠ¤
        let cameraGallery;

        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            cameraGallery = new CameraGallery();
            positionDataManager.init();
            
            // ë‚ ì§œ ì…ë ¥ í•„ë“œ ì´ˆê¸°ê°’ ì„¤ì • - ë¡œì»¬ ì‹œê°„ ê¸°ì¤€
            const now = new Date();
            const yesterday = new Date(now.getTime() - 24*60*60*1000);
            
            // ë¡œì»¬ ì‹œê°„ì„ datetime-local í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const formatLocalDateTime = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            };
            
            document.getElementById('serverStartDate').value = formatLocalDateTime(yesterday);
            document.getElementById('serverEndDate').value = formatLocalDateTime(now);
            
            // íƒ­ ì „í™˜ ì‹œ ìƒ‰ìƒ ë³€ê²½ ë° ë°ì´í„° ë¡œë“œ
            document.getElementById('local-tab').addEventListener('shown.bs.tab', function() {
                this.style.color = '#333';
                document.getElementById('server-tab').style.color = '#fff';
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
                positionDataManager.loadPositions();
            });
            
            document.getElementById('server-tab').addEventListener('shown.bs.tab', function() {
                this.style.color = '#333';
                document.getElementById('local-tab').style.color = '#fff';
                // ì„œë²„ íƒ­ì´ ì„ íƒë˜ë©´ ìë™ìœ¼ë¡œ ì¡°íšŒ (ì„ íƒì‚¬í•­)
                // queryServerPositions();
            });
        });

        // ì „ì—­ í•¨ìˆ˜ë“¤
        function goBackToWatch() {
            cameraGallery.goBackToWatch();
        }

        function captureFromStream() {
            cameraGallery.captureFromStream();
        }

        function clearAllCaptures() {
            cameraGallery.clearAllCaptures();
        }

        function downloadCapture(id) {
            cameraGallery.downloadCapture(id);
        }

        async function deleteCapture(id) {
            await cameraGallery.deleteCapture(id);
        }

        // ì„œë²„ë¡œ ìœ„ì¹˜ ë°ì´í„° ì „ì†¡ í•¨ìˆ˜ (ìº¡ì²˜ ì´ë¯¸ì§€ íŒì—…ìš©)
        async function sendPositionDataToServer() {
            try {
                // í˜„ì¬ íŒì—…ì— í‘œì‹œëœ ìº¡ì²˜ ì´ë¯¸ì§€ì˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const currentImageId = cameraGallery.currentImageId;
                if (!currentImageId) {
                    alert('âŒ ì„ íƒëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const capture = cameraGallery.captures.find(c => c.id === currentImageId);
                if (!capture) {
                    alert('âŒ ìº¡ì²˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // ë””ë²„ê¹…: ìº¡ì²˜ ë°ì´í„° êµ¬ì¡° í™•ì¸
                console.log('ìº¡ì²˜ ë°ì´í„° ì „ì²´:', capture);
                console.log('positionData:', capture.positionData);
                console.log('overlayData:', capture.overlayData);
                
                // ìº¡ì²˜ ë°ì´í„°ì— í¬í•¨ëœ ìœ„ì¹˜ ì •ë³´ í™•ì¸ - ì—¬ëŸ¬ ê²½ë¡œ ì‹œë„
                let positionData = null;
                
                // 1. positionData ì§ì ‘ í™•ì¸
                if (capture.positionData && capture.positionData.LATITUDE) {
                    positionData = capture.positionData;
                    console.log('positionDataì—ì„œ ìœ„ì¹˜ ì •ë³´ ë°œê²¬');
                }
                // 2. overlayData ì§ì ‘ í™•ì¸
                else if (capture.overlayData && capture.overlayData.LATITUDE) {
                    positionData = capture.overlayData;
                    console.log('overlayDataì—ì„œ ìœ„ì¹˜ ì •ë³´ ë°œê²¬');
                }
                // 3. overlayData.sensorData í™•ì¸
                else if (capture.overlayData?.sensorData?.LATITUDE) {
                    positionData = capture.overlayData.sensorData;
                    console.log('overlayData.sensorDataì—ì„œ ìœ„ì¹˜ ì •ë³´ ë°œê²¬');
                }
                // 4. overlayData.userScreenData.sensorData í™•ì¸ (ì„œë²„ APIì™€ ë™ì¼í•œ ê²½ë¡œ)
                else if (capture.overlayData?.userScreenData?.sensorData?.LATITUDE) {
                    positionData = capture.overlayData.userScreenData.sensorData;
                    console.log('overlayData.userScreenData.sensorDataì—ì„œ ìœ„ì¹˜ ì •ë³´ ë°œê²¬');
                }
                
                if (!positionData || !positionData.LATITUDE || !positionData.LONGITUDE) {
                    console.error('ìœ„ì¹˜ ë°ì´í„° ì—†ìŒ:', { capture, positionData });
                    alert('âŒ ì´ ìº¡ì²˜ì— ìœ„ì¹˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // ìœ„ì¹˜ ë°ì´í„° ì „ì†¡
                console.log('ğŸ“ ìº¡ì²˜ ì´ë¯¸ì§€ì˜ ìœ„ì¹˜ ë°ì´í„° ì „ì†¡:', positionData);
                
                // ì•Œë¦¼ í‘œì‹œ
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-info alert-dismissible fade show position-fixed';
                alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                alertDiv.innerHTML = `
                    <strong>ğŸ“ ìœ„ì¹˜ ë°ì´í„° ì „ì†¡ ì¤‘...</strong><br>
                    ìœ„ë„: ${parseFloat(positionData.LATITUDE).toFixed(6)}<br>
                    ê²½ë„: ${parseFloat(positionData.LONGITUDE).toFixed(6)}<br>
                    ê³ ë„: ${parseFloat(positionData.ALTITUDE || 0).toFixed(1)}m
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(alertDiv);

                // ì„œë²„ APIë¥¼ í†µí•œ ì§ì ‘ ì „ì†¡ (JWT ì¸ì¦ ìš°íšŒ)
                const positionResponse = await fetch('/api/position-history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        device_id: positionData.DEVICE_ID || 'DJI_DEVICE_001',
                        latitude: parseFloat(positionData.LATITUDE),
                        longitude: parseFloat(positionData.LONGITUDE),
                        altitude: parseFloat(positionData.ALTITUDE || 0),
                        speed: parseFloat(positionData.SPEED || 0),
                        heading: parseFloat(positionData.AZIMUTH || 0),
                        battery_level: positionData.BATTERY_LEVEL ? parseFloat(positionData.BATTERY_LEVEL) : null,
                        timestamp: capture.timestamp || positionData.TIME || positionData.timestamp || null,
                        metadata: {
                            ...positionData,
                            capture_id: capture.id,
                            capture_time: capture.timestamp
                        }
                    })
                });

                const result = await positionResponse.json();
                
                // ê²°ê³¼ì— ë”°ë¼ ì•Œë¦¼ ì—…ë°ì´íŠ¸
                setTimeout(() => {
                    if (result.success) {
                        alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
                        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                        alertDiv.innerHTML = `
                            <strong>âœ… ìœ„ì¹˜ ë°ì´í„° ì „ì†¡ ì™„ë£Œ!</strong><br>
                            ë””ë°”ì´ìŠ¤: ${result.device_id || 'Unknown'}<br>
                            <small>${result.message || 'ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'}</small>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                    } else {
                        alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
                        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                        alertDiv.innerHTML = `
                            <strong>âŒ ìœ„ì¹˜ ë°ì´í„° ì „ì†¡ ì‹¤íŒ¨!</strong><br>
                            ì˜¤ë¥˜: ${result.error}<br>
                            <small>ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”</small>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                    }
                    
                    // 8ì´ˆ í›„ ìë™ ì‚­ì œ
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.remove();
                        }
                    }, 8000);
                }, 1000);

                // Position API í†µê³„ ì¶œë ¥
                const stats = window.positionAPI.getStats();
                console.log('ğŸ“Š Position API í†µê³„:', stats);

            } catch (error) {
                console.error('ìœ„ì¹˜ ë°ì´í„° ì „ì†¡ ì‹¤íŒ¨:', error);
                alert(`âŒ ìœ„ì¹˜ ë°ì´í„° ì „ì†¡ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        function showImageDetail(id) {
            cameraGallery.showImageDetail(id);
        }

        // ìœ„ì¹˜ ë°ì´í„° ê´€ë¦¬ í•¨ìˆ˜ë“¤
        let positionDataManager = {
            positions: [],
            selectedPositions: new Set(),
            
            init() {
                this.loadPositions();
                this.updateBadgeCount();
            },
            
            loadPositions() {
                // ë©”ì¸ ê°¤ëŸ¬ë¦¬ì™€ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ìº¡ì²˜ ë°ì´í„°ì—ì„œ ìœ„ì¹˜ ì •ë³´ ì¶”ì¶œ
                this.positions = [];
                
                // streamCapturesì—ì„œ ìœ„ì¹˜ ë°ì´í„° ì¶”ì¶œ (ë©”ì¸ ê°¤ëŸ¬ë¦¬ì™€ ë™ì¼)
                const captures = localStorage.getItem('streamCaptures');
                if (captures) {
                    try {
                        const captureData = JSON.parse(captures);
                        captureData.forEach((capture, index) => {
                            // ë©”ì¸ ê°¤ëŸ¬ë¦¬ì™€ ë™ì¼í•œ ê²½ë¡œë¡œ ìœ„ì¹˜ ë°ì´í„° í™•ì¸
                            let posData = null;
                            
                            // 1. positionData ì§ì ‘ í™•ì¸
                            if (capture.positionData && capture.positionData.LATITUDE) {
                                posData = capture.positionData;
                            }
                            // 2. overlayData ì§ì ‘ í™•ì¸
                            else if (capture.overlayData && capture.overlayData.LATITUDE) {
                                posData = capture.overlayData;
                            }
                            // 3. overlayData.sensorData í™•ì¸
                            else if (capture.overlayData?.sensorData?.LATITUDE) {
                                posData = capture.overlayData.sensorData;
                            }
                            // 4. overlayData.userScreenData.sensorData í™•ì¸
                            else if (capture.overlayData?.userScreenData?.sensorData?.LATITUDE) {
                                posData = capture.overlayData.userScreenData.sensorData;
                            }
                            
                            if (posData && posData.LATITUDE && posData.LONGITUDE) {
                                // ìº¡ì²˜ ì •ë³´ë„ í•¨ê»˜ ì €ì¥
                                this.positions.push({
                                    ...posData,
                                    captureId: capture.id,
                                    captureTime: capture.timestamp,
                                    streamKey: capture.streamKey
                                });
                            }
                        });
                        console.log(`ìº¡ì²˜ì—ì„œ ìœ„ì¹˜ ë°ì´í„° ì¶”ì¶œ: ${this.positions.length}ê°œ`);
                    } catch (e) {
                        console.error('ìº¡ì²˜ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
                    }
                }
                
                // ê¸°ì¡´ dronePositionHistoryê°€ ìˆìœ¼ë©´ ì¶”ê°€ (í•˜ìœ„ í˜¸í™˜ì„±)
                const legacyData = localStorage.getItem('dronePositionHistory');
                if (legacyData) {
                    try {
                        const legacyPositions = JSON.parse(legacyData);
                        // ì¤‘ë³µ ì œê±°ë¥¼ ìœ„í•´ ê¸°ì¡´ ë°ì´í„°ì™€ ë¹„êµ
                        legacyPositions.forEach(pos => {
                            const isDuplicate = this.positions.some(p => 
                                p.LATITUDE === pos.LATITUDE && 
                                p.LONGITUDE === pos.LONGITUDE && 
                                p.TIME === pos.TIME
                            );
                            if (!isDuplicate) {
                                this.positions.push(pos);
                            }
                        });
                        console.log(`Legacy ìœ„ì¹˜ ë°ì´í„° ì¶”ê°€: ì´ ${this.positions.length}ê°œ`);
                    } catch (e) {
                        console.error('Legacy ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
                    }
                }
                
                this.renderPositionList();
                this.updateBadgeCount();
            },
            
            updateBadgeCount() {
                const count = this.positions.length;
                document.getElementById('localPositionBadge').textContent = count;
                document.getElementById('localTabBadge').textContent = count;
            },
            
            renderPositionList() {
                const listContainer = document.getElementById('positionList');
                if (!listContainer) return;
                
                if (this.positions.length === 0) {
                    listContainer.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            ì €ì¥ëœ ìœ„ì¹˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    `;
                    return;
                }
                
                const html = this.positions.map((pos, index) => {
                    // ìº¡ì²˜ ì‹œê°„ ìš°ì„ , ì—†ìœ¼ë©´ ë‹¤ë¥¸ ì‹œê°„ í•„ë“œ ì‚¬ìš©
                    const time = pos.captureTime || pos.TIME || pos.timestamp || new Date().toISOString();
                    const date = new Date(time);
                    const isSelected = this.selectedPositions.has(index);
                    
                    return `
                        <div class="position-item border rounded p-2 mb-2 ${isSelected ? 'bg-light' : ''}" data-index="${index}">
                            <div class="form-check">
                                <input class="form-check-input position-checkbox" type="checkbox" 
                                       value="${index}" id="pos-${index}" 
                                       ${isSelected ? 'checked' : ''} 
                                       onchange="positionDataManager.toggleSelection(${index})">
                                <label class="form-check-label w-100" for="pos-${index}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>${pos.DEVICE_ID || pos.streamKey || 'Unknown'}</strong>
                                            <small class="text-muted ms-2">
                                                ${date.toLocaleString('ko-KR')}
                                            </small>
                                            ${pos.captureId ? `<small class="text-info ms-1">[ìº¡ì²˜]</small>` : ''}
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-map-marker-alt"></i>
                                                ${parseFloat(pos.LATITUDE || 0).toFixed(4)}, ${parseFloat(pos.LONGITUDE || 0).toFixed(4)}
                                            </span>
                                            <span class="badge bg-info ms-1">
                                                <i class="fas fa-arrow-up"></i>
                                                ${parseFloat(pos.ALTITUDE || 0).toFixed(1)}m
                                            </span>
                                            ${pos.BATTERY_LEVEL ? `
                                                <span class="badge ${parseFloat(pos.BATTERY_LEVEL) < 30 ? 'bg-danger' : 'bg-success'} ms-1">
                                                    <i class="fas fa-battery-half"></i>
                                                    ${Math.round(parseFloat(pos.BATTERY_LEVEL))}%
                                                </span>
                                            ` : ''}
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    `;
                }).join('');
                
                listContainer.innerHTML = html;
            },
            
            toggleSelection(index) {
                if (this.selectedPositions.has(index)) {
                    this.selectedPositions.delete(index);
                } else {
                    this.selectedPositions.add(index);
                }
                this.renderPositionList();
            },
            
            selectAll() {
                this.positions.forEach((_, index) => {
                    this.selectedPositions.add(index);
                });
                this.renderPositionList();
            },
            
            deselectAll() {
                this.selectedPositions.clear();
                this.renderPositionList();
            },
            
            async sendSelected() {
                if (this.selectedPositions.size === 0) {
                    alert('ì „ì†¡í•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.');
                    return;
                }
                
                const selectedData = Array.from(this.selectedPositions).map(index => this.positions[index]);
                const progressAlert = this.showProgressAlert(`0/${selectedData.length}ê°œ ì „ì†¡ ì¤‘...`);
                
                let successCount = 0;
                let failCount = 0;
                
                for (const [i, position] of selectedData.entries()) {
                    try {
                        const response = await fetch('/api/position-history', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                device_id: position.DEVICE_ID || 'DJI_DEVICE_001',
                                latitude: position.LATITUDE,
                                longitude: position.LONGITUDE,
                                altitude: position.ALTITUDE || 0,
                                speed: position.SPEED || 0,
                                heading: position.AZIMUTH || 0,
                                battery_level: position.BATTERY_LEVEL || null,
                                timestamp: position.TIME || position.timestamp || null,
                                metadata: position
                            })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                        
                        // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
                        progressAlert.querySelector('.alert-content').innerHTML = 
                            `${i + 1}/${selectedData.length}ê°œ ì „ì†¡ ì¤‘... (ì„±ê³µ: ${successCount}, ì‹¤íŒ¨: ${failCount})`;
                        
                    } catch (error) {
                        console.error('ì „ì†¡ ì˜¤ë¥˜:', error);
                        failCount++;
                    }
                }
                
                // ì„±ê³µí•œ í•­ëª© ì œê±°
                if (successCount > 0) {
                    const indicesToRemove = Array.from(this.selectedPositions).sort((a, b) => b - a);
                    indicesToRemove.forEach(index => {
                        if (successCount > 0) {
                            this.positions.splice(index, 1);
                        }
                    });
                    
                    // localStorage ì—…ë°ì´íŠ¸
                    localStorage.setItem('dronePositionHistory', JSON.stringify(this.positions));
                    this.selectedPositions.clear();
                    this.loadPositions();
                }
                
                // ê²°ê³¼ ì•Œë¦¼
                progressAlert.remove();
                this.showResultAlert(
                    `ì „ì†¡ ì™„ë£Œ: ì„±ê³µ ${successCount}ê°œ, ì‹¤íŒ¨ ${failCount}ê°œ`,
                    successCount > 0 ? 'success' : 'danger'
                );
            },
            
            deleteSelected() {
                if (this.selectedPositions.size === 0) {
                    alert('ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.');
                    return;
                }
                
                if (!confirm(`ì„ íƒí•œ ${this.selectedPositions.size}ê°œ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    return;
                }
                
                // ì¸ë±ìŠ¤ë¥¼ ì—­ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ì‚­ì œ (ë°°ì—´ ì¸ë±ìŠ¤ ë³´ì¡´)
                const indicesToRemove = Array.from(this.selectedPositions).sort((a, b) => b - a);
                indicesToRemove.forEach(index => {
                    this.positions.splice(index, 1);
                });
                
                // localStorage ì—…ë°ì´íŠ¸
                localStorage.setItem('dronePositionHistory', JSON.stringify(this.positions));
                this.selectedPositions.clear();
                this.loadPositions();
                
                this.showResultAlert(`${indicesToRemove.length}ê°œ í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'warning');
            },
            
            showProgressAlert(message) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-info alert-dismissible fade show position-fixed';
                alertDiv.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 300px;';
                alertDiv.innerHTML = `
                    <div class="alert-content">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        ${message}
                    </div>
                `;
                document.body.appendChild(alertDiv);
                return alertDiv;
            },
            
            showResultAlert(message, type = 'success') {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
                alertDiv.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 300px;';
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(alertDiv);
                
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
        };
        
        // ì „ì—­ í•¨ìˆ˜ë“¤
        function togglePositionDataSection() {
            const section = document.getElementById('positionDataSection');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                // ì„¹ì…˜ì´ ì—´ë¦´ ë•Œ ë¡œì»¬ íƒ­ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ë°ì´í„° ë¡œë“œ
                if (document.getElementById('local-tab').classList.contains('active')) {
                    positionDataManager.loadPositions();
                }
            } else {
                section.style.display = 'none';
            }
        }
        
        function selectAllPositions() {
            positionDataManager.selectAll();
        }
        
        function deselectAllPositions() {
            positionDataManager.deselectAll();
        }
        
        function sendSelectedPositions() {
            positionDataManager.sendSelected();
        }
        
        function deleteSelectedPositions() {
            positionDataManager.deleteSelected();
        }
        
        function refreshPositionData() {
            positionDataManager.loadPositions();
        }

        function downloadCurrentImage() {
            cameraGallery.downloadCurrentImage();
        }

        function deleteCurrentImage() {
            cameraGallery.deleteCurrentImage();
        }
        
        // ì‹œê°„ ë²”ìœ„ ì„¤ì • í•¨ìˆ˜
        function setTimeRange(hours) {
            const now = new Date();
            const startDate = new Date(now.getTime() - hours * 60 * 60 * 1000);
            
            // ë¡œì»¬ ì‹œê°„ì„ datetime-local í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const formatLocalDateTime = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            };
            
            // ë‚ ì§œ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
            document.getElementById('serverStartDate').value = formatLocalDateTime(startDate);
            document.getElementById('serverEndDate').value = formatLocalDateTime(now);
            
            // ìë™ìœ¼ë¡œ ì¡°íšŒ ì‹¤í–‰
            queryServerPositions();
        }
        
        // ì„œë²„ API ì¡°íšŒ í•¨ìˆ˜ë“¤
        async function queryServerPositions() {
            const deviceId = document.getElementById('serverDeviceId').value;
            const startDate = document.getElementById('serverStartDate').value;
            const endDate = document.getElementById('serverEndDate').value;
            const limit = document.getElementById('serverLimit').value;
            
            if (!deviceId) {
                alert('ë””ë°”ì´ìŠ¤ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            const listContainer = document.getElementById('serverPositionList');
            listContainer.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p>ì¡°íšŒ ì¤‘...</p></div>';
            
            try {
                const response = await fetch('/api/position-history/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        device_id: deviceId,
                        start_date: startDate ? new Date(startDate).toISOString() : undefined,
                        end_date: endDate ? new Date(endDate).toISOString() : undefined,
                        limit: parseInt(limit) || 100
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
                }

                const result = await response.json();
                const data = result.data || result; // data ê°ì²´ì—ì„œ ë°°ì—´ ì¶”ì¶œ
                renderServerPositions(data);
                document.getElementById('serverTabBadge').textContent = data.length;
                
            } catch (error) {
                console.error('ì„œë²„ ì¡°íšŒ ì‹¤íŒ¨:', error);
                listContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ì¡°íšŒ ì‹¤íŒ¨: ${error.message}
                    </div>`;
            }
        }
        
        
        function renderServerPositions(positions) {
            const listContainer = document.getElementById('serverPositionList');
            
            if (!positions || positions.length === 0) {
                listContainer.innerHTML = '<div class="alert alert-info">ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            let html = '<div class="list-group">';
            positions.forEach(pos => {
                const timestamp = new Date(pos.timestamp || pos.position_timestamp).toLocaleString('ko-KR');
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${timestamp}</h6>
                                <p class="mb-1">
                                    <i class="fas fa-map-marker-alt text-danger me-1"></i>
                                    ìœ„ë„: ${pos.latitude.toFixed(6)}Â°, ê²½ë„: ${pos.longitude.toFixed(6)}Â°
                                </p>
                                <small class="text-muted">
                                    ê³ ë„: ${pos.altitude}m | ì†ë„: ${pos.speed}km/h | 
                                    ë°©í–¥: ${pos.heading}Â° | ë°°í„°ë¦¬: ${pos.battery_level}%
                                    ${pos.distance_from_previous ? ` | ì´ë™ê±°ë¦¬: ${pos.distance_from_previous.toFixed(2)}m` : ''}
                                </small>
                            </div>
                            <span class="badge bg-primary">#${pos.id}</span>
                        </div>
                    </div>`;
            });
            html += '</div>';
            
            listContainer.innerHTML = html;
        }
        

        // ì™¸ë¶€ì—ì„œ ìº¡ì²˜ ë°ì´í„°ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆëŠ” í•¨ìˆ˜ (watch.htmlì—ì„œ í˜¸ì¶œìš©)
        window.addCaptureToGallery = function(captureData) {
            if (cameraGallery) {
                cameraGallery.addCapture(captureData);
            }
        };
        
        // ì„œë²„ íŒŒì¼ë¡œë¶€í„° ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì¬ìƒì„± (ì„ì‹œ ê¸°ëŠ¥)
        async function syncFromServerFiles() {
            if (!confirm('âš ï¸ ê²½ê³ : í˜„ì¬ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì˜ ëª¨ë“  ìº¡ì²˜ ë°ì´í„°ê°€ ì‚­ì œë˜ê³  ì„œë²„ íŒŒì¼ë¡œ êµì²´ë©ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                // ê¸°ì¡´ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ í´ë¦¬ì–´ - captureStorage APIì™€ ë™ì¼í•œ í‚¤ ì‚¬ìš©
                localStorage.removeItem('streamCaptures');
                localStorage.removeItem('captureData');
                
                // ë¡œë”© í‘œì‹œ
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-info position-fixed';
                alertDiv.style.cssText = 'top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; min-width: 300px;';
                alertDiv.innerHTML = `
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    ì„œë²„ íŒŒì¼ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘...
                `;
                document.body.appendChild(alertDiv);
                
                // ì„œë²„ì—ì„œ ìº¡ì²˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const response = await fetch('/api/capture/list');
                if (!response.ok) {
                    throw new Error('ì„œë²„ íŒŒì¼ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                const data = await response.json();
                let serverCaptures = data.captures || [];
                
                // 2025-09-13 íŒŒì¼ë§Œ í•„í„°ë§
                serverCaptures = serverCaptures.filter(cap => cap.filename.includes('2025-09-13'));
                
                alertDiv.innerHTML = `
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    ${serverCaptures.length}ê°œ íŒŒì¼ ë©”íƒ€ë°ì´í„° ì²˜ë¦¬ ì¤‘...
                `;
                
                // ì„œë²„ íŒŒì¼ ì°¸ì¡°ë§Œ ì €ì¥ (ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ í•˜ì§€ ì•ŠìŒ)
                const newCaptures = [];
                let processedCount = 0;
                
                // ìµœëŒ€ 20ê°œë§Œ ì²˜ë¦¬ (ìš©ëŸ‰ ì œí•œ)
                const maxItems = Math.min(serverCaptures.length, 20);
                
                for (let i = 0; i < maxItems; i++) {
                    const serverCapture = serverCaptures[i];
                    try {
                        // ìº¡ì²˜ ê°ì²´ ìƒì„± (ì´ë¯¸ì§€ URLë§Œ ì €ì¥)
                        const captureObj = {
                            id: 'server_' + serverCapture.filename.replace(/\.[^/.]+$/, ''),
                            // dataUrl ëŒ€ì‹  ì„œë²„ íŒŒì¼ ì°¸ì¡° ì €ì¥
                            serverFile: serverCapture.filename,
                            serverPath: serverCapture.filepath,
                            imageUrl: `/api/capture/download/${serverCapture.filename}`,
                            timestamp: serverCapture.createdAt || serverCapture.timestamp || new Date().toISOString(),
                            streamKey: serverCapture.streamKey || 'ah01',
                            width: serverCapture.metadata?.width || 1920,
                            height: serverCapture.metadata?.height || 1080,
                            serverFilename: serverCapture.filename,
                            overlayData: serverCapture.metadata?.overlayData || {},
                            positionData: serverCapture.metadata?.overlayData?.sensorData || null,
                            syncedFromServer: true,
                            savedToServer: true
                        };
                        
                        newCaptures.push(captureObj);
                        processedCount++;
                        
                        alertDiv.innerHTML = `
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            ì²˜ë¦¬ ì¤‘... (${processedCount}/${maxItems})
                        `;
                        
                    } catch (error) {
                        console.error(`íŒŒì¼ ì²˜ë¦¬ ì‹¤íŒ¨: ${serverCapture.filename}`, error);
                    }
                }
                
                // ìµœì‹ ìˆœ ì •ë ¬ (timestamp ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ)
                newCaptures.sort((a, b) => {
                    const timeA = new Date(a.timestamp).getTime();
                    const timeB = new Date(b.timestamp).getTime();
                    return timeB - timeA; // ìµœì‹ ì´ ë¨¼ì €
                });
                
                // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ (ì´ë¯¸ì§€ ì—†ì´ ë©”íƒ€ë°ì´í„°ë§Œ)
                try {
                    localStorage.setItem('streamCaptures', JSON.stringify(newCaptures));
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        // ìš©ëŸ‰ ì´ˆê³¼ì‹œ ì ˆë°˜ë§Œ ì €ì¥
                        const halfCaptures = newCaptures.slice(0, Math.floor(newCaptures.length / 2));
                        localStorage.setItem('streamCaptures', JSON.stringify(halfCaptures));
                        alert(`âš ï¸ ìš©ëŸ‰ ì œí•œìœ¼ë¡œ ${halfCaptures.length}ê°œë§Œ ë¡œë“œë©ë‹ˆë‹¤.`);
                    }
                }
                
                // ê°¤ëŸ¬ë¦¬ ìƒˆë¡œê³ ì¹¨
                // renderGalleryë¥¼ í˜¸ì¶œí•˜ë©´ ìë™ìœ¼ë¡œ captureStorage APIë¥¼ í†µí•´ ë¡œë“œë¨
                await cameraGallery.renderGallery();
                
                alertDiv.remove();
                
                // ì„±ê³µ ë©”ì‹œì§€
                alert(`âœ… ì„œë²„ íŒŒì¼ ë™ê¸°í™” ì™„ë£Œ!\n\nì´ ${processedCount}ê°œì˜ ìº¡ì²˜ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`);
                
                // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                location.reload();
                
            } catch (error) {
                console.error('ì„œë²„ íŒŒì¼ ë™ê¸°í™” ì‹¤íŒ¨:', error);
                alert('âŒ ë™ê¸°í™” ì‹¤íŒ¨: ' + error.message);
                
                // ë¡œë”© í‘œì‹œ ì œê±°
                const alertDiv = document.querySelector('.alert.position-fixed');
                if (alertDiv) alertDiv.remove();
            }
        }
    </script>
</body>
</html>