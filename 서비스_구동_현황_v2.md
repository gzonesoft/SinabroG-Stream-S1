# SinabroG-Stream-S1 서비스 구동 현황 v2

## 프로젝트 개요
- **프로젝트명**: SinabroG-Stream-S1
- **주요 기능**: DJI 드론 RTMP 스트리밍 서비스 및 실시간 오버레이 데이터 제공
- **도메인**: ai.gzonesoft.com
- **SSL 인증서**: 적용됨 (ai.gzonesoft.com)

## 서비스 포트 현황

| 포트 | 프로토콜 | 서비스명 | 기능 설명 | 접속 URL/주소 | 상태 |
|------|----------|---------|-----------|--------------|------|
| 17935 | RTMP | RTMP 스트리밍 서버 | DJI 드론 등 RTMP 클라이언트의 실시간 영상 스트림 수신 | rtmp://ai.gzonesoft.com:17935/live/[스트림키] | 구동중 |
| 17936 | HTTP | 웹 인터페이스 (리다이렉트) | HTTPS로 자동 리다이렉션 | http://ai.gzonesoft.com:17936 → 17937 | 구동중 |
| 17937 | HTTPS | 메인 웹 인터페이스 | 스트리밍 관리 및 시청 페이지 제공, Socket.IO 통신 | https://ai.gzonesoft.com:17937 | 구동중 |
| 18001 | HTTP | HTTP-FLV 스트리밍 | HTTP 기반 FLV 포맷 스트림 제공 | http://ai.gzonesoft.com:18001/live/[키].flv | 구동중 |
| 18002 | HTTPS | HTTPS-FLV 스트리밍 | HTTPS 보안 FLV 포맷 스트림 제공 | https://ai.gzonesoft.com:18002/live/[키].flv | 구동중 |

## 주요 서비스 구성

### 1. RTMP 스트리밍 서버 (server.js)
**주요 기능:**
- RTMP 프로토콜을 통한 실시간 영상 스트림 수신
- HTTP/HTTPS-FLV 포맷으로 웹 브라우저 스트리밍 지원
- 다중 스트림 관리 및 세션 추적
- 실시간 시청자 수 카운팅
- Socket.IO를 통한 실시간 이벤트 브로드캐스팅

**제공 API:**
| 엔드포인트 | 메소드 | 기능 |
|-----------|--------|------|
| `/` | GET | 메인 관리 페이지 |
| `/watch` | GET | 시청자용 스트리밍 페이지 |
| `/simple` | GET | 간단한 시청 페이지 |
| `/camera` | GET | 카메라 갤러리 페이지 |
| `/test` | GET | 스트림 테스트 페이지 |
| `/api/streams` | GET | 활성 스트림 목록 조회 |
| `/api/streams/:id` | GET | 특정 스트림 상태 조회 |
| `/api/generate-key` | POST | 스트림 키 생성 |
| `/api/overlay-data` | GET | 실시간 오버레이 데이터 조회 |
| `/api/overlay-data` | POST | 외부 앱에서 위치 데이터 업데이트 |
| `/api/capture/save` | POST | 스트림 캡처 이미지 저장 |
| `/api/capture/list` | GET | 저장된 캡처 목록 조회 |
| `/api/capture/download/:filename` | GET | 캡처 이미지 다운로드 |
| `/api/capture/delete/:filename` | DELETE | 캡처 이미지 삭제 |

### 2. 오버레이 데이터 업데이트 서비스 (update-overlay-data.js)
**주요 기능:**
- 5초 간격으로 드론 텔레메트리 데이터 시뮬레이션
- 위치 정보 (위도, 경도, 고도) 실시간 업데이트
- 드론 상태 정보 (속도, 방위각, 틸트, 롤) 업데이트
- 부드러운 데이터 변화를 위한 smoothing 알고리즘 적용
- data_overly.json 파일 실시간 갱신

**생성 데이터:**
| 데이터 항목 | 설명 | 범위/단위 |
|------------|------|----------|
| LATITUDE | 위도 | ±0.001도 변동 |
| LONGITUDE | 경도 | ±0.001도 변동 |
| ALTITUDE | 고도 | 100-200m |
| SPEED | 속도 | 0-25 m/s |
| AZIMUTH | 방위각 | 0-360° |
| TILT | 틸트 | -15°~15° |
| ROLL | 롤 | -10°~10° |
| TIME | 타임스탬프 | ISO 8601 형식 |

## 외부 앱에서 오버레이 데이터 API 호출 방법

### GET 요청 - 현재 오버레이 데이터 조회

#### 기본 조회
```bash
curl http://ai.gzonesoft.com:17937/api/overlay-data
```

#### HTTPS로 조회
```bash
curl https://ai.gzonesoft.com:17937/api/overlay-data
```

#### JSON 포맷팅해서 보기
```bash
curl https://ai.gzonesoft.com:17937/api/overlay-data | python -m json.tool
```

#### 응답 예시
```json
{
  "LATITUDE": 37.5665,
  "LONGITUDE": 126.9780,
  "ALTITUDE": 120,
  "SPEED": 15.5,
  "AZIMUTH": 180,
  "TILT": 5,
  "ROLL": -2,
  "TIME": "2025-01-10T10:30:00.000Z",
  "_lastModified": "2025-01-10T10:30:00.000Z",
  "_timestamp": "2025-01-10T10:30:01.000Z"
}
```

### POST 요청 - 외부 앱에서 위치 데이터 업데이트

#### 기본 위치 데이터 전송
```bash
curl -X POST https://ai.gzonesoft.com:17937/api/overlay-data \
  -H "Content-Type: application/json" \
  -d '{
    "LATITUDE": 37.5670,
    "LONGITUDE": 126.9785,
    "ALTITUDE": 150
  }'
```

#### 전체 텔레메트리 데이터 전송
```bash
curl -X POST https://ai.gzonesoft.com:17937/api/overlay-data \
  -H "Content-Type: application/json" \
  -d '{
    "LATITUDE": 37.5670,
    "LONGITUDE": 126.9785,
    "ALTITUDE": 150,
    "SPEED": 20.5,
    "AZIMUTH": 270,
    "TILT": 10,
    "ROLL": -5,
    "TIME": "'$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")'"
  }'
```

#### Android/iOS 앱에서 위치 데이터 전송 예시 (Kotlin)
```kotlin
val url = URL("https://ai.gzonesoft.com:17937/api/overlay-data")
val json = JSONObject()
json.put("LATITUDE", location.latitude)
json.put("LONGITUDE", location.longitude)
json.put("ALTITUDE", location.altitude)
json.put("SPEED", location.speed)
json.put("TIME", SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSS'Z'").format(Date()))

val connection = url.openConnection() as HttpURLConnection
connection.requestMethod = "POST"
connection.setRequestProperty("Content-Type", "application/json")
connection.doOutput = true

connection.outputStream.use { os ->
    val input = json.toString().toByteArray(charset("utf-8"))
    os.write(input, 0, input.size)
}

val responseCode = connection.responseCode
```

#### iOS 앱에서 위치 데이터 전송 예시 (Swift)
```swift
let url = URL(string: "https://ai.gzonesoft.com:17937/api/overlay-data")!
var request = URLRequest(url: url)
request.httpMethod = "POST"
request.setValue("application/json", forHTTPHeaderField: "Content-Type")

let data = [
    "LATITUDE": location.coordinate.latitude,
    "LONGITUDE": location.coordinate.longitude,
    "ALTITUDE": location.altitude,
    "SPEED": location.speed,
    "TIME": ISO8601DateFormatter().string(from: Date())
] as [String : Any]

request.httpBody = try? JSONSerialization.data(withJSONObject: data)

URLSession.shared.dataTask(with: request) { data, response, error in
    // 응답 처리
}.resume()
```

#### 실시간 위치 업데이트 (5초마다)
```bash
#!/bin/bash
while true; do
  # GPS 또는 다른 소스에서 위치 정보 가져오기
  LAT=$(get_current_latitude)
  LNG=$(get_current_longitude)
  ALT=$(get_current_altitude)
  
  curl -X POST https://ai.gzonesoft.com:17937/api/overlay-data \
    -H "Content-Type: application/json" \
    -d "{
      \"LATITUDE\": $LAT,
      \"LONGITUDE\": $LNG,
      \"ALTITUDE\": $ALT,
      \"TIME\": \"$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")\"
    }"
  
  sleep 5
done
```

### 인증 토큰 사용 (보안 강화 시)
```bash
curl -X POST https://ai.gzonesoft.com:17937/api/overlay-data \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_API_TOKEN" \
  -d '{
    "LATITUDE": 37.5670,
    "LONGITUDE": 126.9785,
    "ALTITUDE": 150
  }'
```

### 오류 처리
```bash
# 타임아웃 설정 (5초)
curl -X POST https://ai.gzonesoft.com:17937/api/overlay-data \
  --max-time 5 \
  -H "Content-Type: application/json" \
  -d '{"LATITUDE": 37.5670, "LONGITUDE": 126.9785}' \
  || echo "요청 실패"
```

### 응답 상태 코드
- `200 OK`: 데이터 업데이트 성공
- `400 Bad Request`: 잘못된 데이터 형식
- `404 Not Found`: 엔드포인트 없음
- `500 Internal Server Error`: 서버 오류

## 웹 페이지 구성

| 페이지 | 경로 | 용도 |
|--------|------|------|
| 메인 관리 페이지 | `/index.html` | 스트리밍 서버 관리 및 설정 |
| 시청자 페이지 | `/watch.html` | 실시간 스트림 시청 및 오버레이 표시 |
| 간단 시청 페이지 | `/simple.html` | 최소 UI 스트림 시청 |
| 카메라 갤러리 | `/camera.html` | 다중 카메라 뷰 지원 |
| 테스트 페이지 | `/test.html` | 스트리밍 연결 테스트 |

## 시작/종료 스크립트

| 스크립트 | 용도 | 실행 방법 |
|----------|------|-----------|
| `start-all-services.sh` | 모든 서비스 일괄 시작 | `./start-all-services.sh` |
| `stop-all-services.sh` | 모든 서비스 일괄 종료 | `./stop-all-services.sh` |
| `start-server.sh` | 스트리밍 서버만 시작 | `./start-server.sh` |
| `stop-server.sh` | 스트리밍 서버만 종료 | `./stop-server.sh` |

## 로그 파일

| 로그 파일 | 내용 | 확인 명령 |
|-----------|------|-----------|
| `server.log` | 스트리밍 서버 운영 로그 | `tail -f server.log` |
| `overlay-data.log` | 오버레이 데이터 업데이트 로그 | `tail -f overlay-data.log` |

## 프로세스 관리

서비스 시작 시 PID 파일이 생성되어 프로세스 관리에 사용됩니다:
- `/tmp/streaming-server.pid` - 스트리밍 서버 PID
- `/tmp/overlay-updater.pid` - 오버레이 업데이터 PID

## 의존성 패키지

| 패키지 | 버전 | 용도 |
|--------|------|------|
| express | ^4.18.2 | 웹 서버 프레임워크 |
| node-media-server | ^2.4.9 | RTMP/HTTP-FLV 스트리밍 서버 |
| socket.io | ^4.7.2 | 실시간 양방향 통신 |
| cors | ^2.8.5 | CORS 정책 관리 |
| multer | ^1.4.5-lts.1 | 파일 업로드 처리 |
| nodemon | ^3.0.1 (dev) | 개발 모드 자동 재시작 |

## 보안 설정
- SSL/TLS 인증서 적용 (ai.gzonesoft.com)
- CORS 설정으로 크로스 도메인 접근 제어
- HTTP → HTTPS 자동 리다이렉션
- 패스프레이즈로 보호된 SSL 키 사용

## 캡처 이미지 저장 경로
- 저장 위치: `/Users/gzonesoft/api_files/stream/capture/`
- 파일 형식: PNG
- 메타데이터: JSON 형식으로 별도 저장

## 작성일자
2025년 1월 10일 (v2 업데이트)